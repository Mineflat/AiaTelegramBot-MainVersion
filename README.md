# Команды

Бот управляется только через сообщения в Телеграмм. Это означает, что невозможно изменить, добавить или удалить:
- Действия
- Людей из белого списка
- Конфигурацию бота
*Их можно только обновить*, используя соответствующие команды. Остальные действия возможны только при **прямом изменении файла**.

Команды, которые вам будут доступны **по-умолчанию**:

| Команда             | Действие                                                                | Только администратор |
| ------------------- | ----------------------------------------------------------------------- | -------------------- |
| `/help`             | Получить список доступных действий                                      | `Нет`                |
| `/get actions`      | То же самое, что и `help`                                               | `Нет`                |
| `/get config`       | Получить конфигурацию бота в данный момент                              | `Да`                 |
| `/get whitelist`    | Получить список идентификаторов администраторов бота (Telegram User ID) | `Да`                 |
| `/update actions`   | Обновить список доступных действий                                      | `Да`                 |
| `/update whitelist` | Обновить список идентификаторов администраторов бота (Telegram User ID) | `Да`                 |
| `/update config`    | Обновить конфигурацию бота                                              | `Да`                 |
| `/ping`             | Если бот жив, он ответит `PONG`                                         | `Да`                 |
| `/get api`          | Получить строку подключения к API, если оно активировано и работает     | `Да`                 |
| `/get action names` | Получить список действий по их именам                                   | `Да`                 |
Это встроенные команды, нетипичные для обычного телеграмм-бота (за исключением команды `help` и ее вариации `get actions`). Поэтому, они не показываются в списке команд и являются **скрытыми**.

Остальные команды задаются конфигурационном файлом в формате `JSON`. Пример такого конфигурационного файла:

```json
{
    "Name": "action 1",
    "Keyword": "get joke",
    "IsActive": "true",
    "IsAdmin": "false",
    "Description": "Описание команды",
    "ActionType": "rand_text",
    "Location": "E:\\workdir\\resources\\jokelist.txt"
}
```

Здесь параметр `Keyword` указывает на то, какая конкретно команда, отданная боту, будет вызывать действие с именем `Name`. Подробнее конфигурирование своих команд описано в главе **Добавление действий**.
# Запуск

Для запуска бота:
1. Заполните конфигурационный файл, расположенный **рядом с исполняемым файлом** самого бота. Если такого файла нет, он будет сгенерирован при первом запуске;
2. Запустите бота командой:
```bash
./AiaTelegramBot [токен_телеграмм_бота]
```
# Конфигурирование
### Основной конфигурационный файл бота

Основной конфигурационный файл бота представляет собой файл `config.json`, расположенный **рядом с исполняемым файлом** самого бота. Если такого файла нет, он будет сгенерирован при первом запуске. Файл содержит следующую JSON-структуру:

```json
{
	"WorkingDirectory": "E:\\workdir",
	"WhitelistLocation": "E:\\workdir\\whitelist.txt",
	"StoreConversationStory":  true,
	"StoreNewUsernames": true,
	"StoreLogs": true,
	"ActionsDirectory": "E:\\workdir\\actions"
}
```

Параметры в конфигурационном файле соответствуют следующей таблице:

| Параметр                 | Действие                                                                                                                                                 | Ожидаемое значение                                | Обязательный |
| ------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- | ------------ |
| `WorkingDirectory`       | Путь к рабочей директории бота, в которой будут расположены логи, история переписки и уникальные идентификаторы пользователей Телеграмм (если разрешено) | Строка                                            | `Да`         |
| `WhitelistLocation`      | Путь к файлу со списком идентификаторов пользователей, которые являются *администраторами* бота                                                          | Строка                                            | `Нет`        |
| `StoreConversationStory` | Указывает, разрешено ли сохранение истории переписки                                                                                                     | Логическое (булевое) значение: `true` или `false` | `Да`         |
| `StoreNewUsernames`      | Указывает, разрешено ли сохранение уникальных идентификаторов пользователей Телеграмм                                                                    | Логическое (булевое) значение: `true` или `false` | `Да`         |
| `StoreLogs`              | Указывает, разрешено ли сохранение файлов истории сообщений (логов) на диске                                                                             | Логическое (булевое) значение: `true` или `false` | `Да`         |
| `ActionsDirectory`       | Указывает, директорию, содержащую файлы действий (команд) в формате JSON                                                                                 | Строка                                            | `Да`         |
### Добавление действий ^addactions

В конфигурационном файле бота `config.json` содержится параметр `ActionsDirectory` - путь до директории с JSON-файлами (действиями).  Файл имеет следующую структуру:

```json
{
    "Name": "action 1",
    "Keyword": "get joke",
    "IsActive": "true",
    "IsAdmin": "false",
    "Description": "Описание команды",
    "ActionType": "rand_text",
    "Location": "E:\\workdir\\resources\\jokelist.txt"
}
```

Каждый параметр отвечает за описание конкретного аспекта действия и соответствует следующей таблице:

| Параметр      | Действие                                                                                                | Ожидаемое значение                                | Обязательный |
| ------------- | ------------------------------------------------------------------------------------------------------- | ------------------------------------------------- | ------------ |
| `Name`        | Имя действия. Используется как тег                                                                      | Строка                                            | `Да`         |
| `Keyword`     | Команда, которая будет инициировать вызов действия                                                      | Строка                                            | `Да`         |
| `IsActive`    | Определяет, является ли команда активной. Если нет, то команду вызвать невозможно                       | Логическое (булевое) значение: `true` или `false` | `Да`         |
| `IsAdmin`     | Определяет, является ли команда публичной или ее может вызывать только администратор бота               | Логическое (булевое) значение: `true` или `false` | `Да`         |
| `Description` | Описание команды, попадающие в вывод команды `help` в соответствующее поле                              | Строка                                            | `Нет`        |
| `ActionType`  | Тип действия. Определяет, какое конкретно действие ожидается выполнить с файлом из параметра `Location` | Строка                                            | `Да`         |
| `Location`    | Путь до файла или директории, с которым необходимо выполнить действия типа `ActionType`                 | Строка                                            | `Да`         |
При этом, поле `ActionType` принимает одно из 5 значений:
- `text`
> Отправить содержимое **текстового** файла в ответном сообщении.
- `random_text`
> Отправить случайную часть текста из файла, при этом части текста разделяются фиксированной последовательностью символов: `##########` (10 символов `#`). Последний отрывок текста так же заканчивается этой последовательностью
- `random_image`
> Отправить случайное изображение из указанной директории. Обратите внимание, что изображение так же может быть отправлено и из поддиректорий (рекурсивный поиск).
>
>**Поддерживаемые типы изображений**: `.jpg`, `.gif`, `.png` и `.jpeg`
- `file`
> Отправить в чат файл по указанному пути, при этом размер файла *не должен превышать* `2МБ` - это ограничение сервиса Телеграмм. 
- `script`
> Выполнить скрипт, путь к которому указан в директиве `Location`. Скрипт так же принимает опции - любой текст, который будет написан после самой команды (в одном сообщении). Перед исполнением скрипта бот укажет, что поставил задачу на выполнение, а после выполнения - отправит в чат весь его вывод

> Обратите внимание!
> Обновление списка команд производится ботом при старте или по команде `update actions`, доступной только администраторам бота.

### Белый список

Белый список - файл, на каждой строчке которого содержится **числовой** идентификатор пользователя Телеграмм. Владельцы этих аккаунтов попадают в белый список бота, они же - **администраторы**.

Администратор *отличается от обычного пользователя* возможностью использовать внутренние команды (не перечисленные в `help`) и запускать действия, помеченные как `"IsAdmin":"true"`

> Обратите внимание!
> Если белый список пуст, то никто из пользователей не является администраторами бота и, следовательно, никто не сможет использовать команды этого типа  

Как получить числовой ID пользователя в Телеграмм?
Чтобы получить **свой** числовой ID, используется бот https://t.me/getmyid_bot - напишите ему сообщение, а бот отправит вам ваш числовой ID и ID чата, в котором вы общаетесь. Этот же бот может получить идентификатор **другого пользователя**, если это позволяют его настройки приватности: перешлите любое сообщение от этого пользователя боту и тот, по возможности, ответит вам идентификатором пользователя в поле `Forwarded from`. Если же бот не сможет определить ID предполагаемого администратора - **пишите самому пользователю**, он разберется :)  

# Возможности API

### Что это такое?

Бот может полностью контролировать действия, описанные для него. Однако, до определенного момента (релиза 15.07.2024), невозможно было обратное. Т.е. невозможно было вернуть из скрипта что-то, что не является текстом, а так же невозможен был каскадный запуск действий и действия, не описанные в конфигурации бота заранее. Решить эту проблему призван **механизм API бота**. 
### Как сконфигурировать?

Чтобы запустить какое-то действие, в конфигурационном файл бота (`config.json`) должны быть прописаны следующие директивы:

```json
"ApiPort": "3200",
"IsApiEnabled": true
```

- `ApiPort` - порт, на котором будет слушать API. Представляет себе число от 1 до 65535 - любой не занятый порт;
- `IsApiEnabled` - указывает, работает ли API а данный момент. Значение `true` - работает, `false` - не работает. 

> Важно!
> API бота работает только на локальном хосте по протоколу HTTP. Это означает, что адрес, по которому отвечает API всегда будет:
> ```bash
> http://127.0.0.1:[ApiPort]/[ID-бота] # вариант 1
> http://localhost:[ApiPort]/[ID-бота] # вариант 2
> ```

При этом идентификатор бота можно увидеть при запуске приложения, а ссылку для подключения к API - по команде `/get api`.

```bash
[INFO][15.07.2024 02:28:37:0449981]: Идентификатор бота: A05E53EF6A167CAE93F361A956D6DC27F6BC1C7C0EAC4E
```
### Как использовать?

Для использования отправьте запрос на API, в котором будет указана конфигурация действия, которое исполнит бот (в формате **JSON**):
- Имя действия *(обязательно)*;
- В какой чат отправить результат выполнения действия *(обязательно)*;
- Аргументы *(при наличии, если запускается скрипт)*.
Получить список действий по их именам вы можете командой `/get action names`.

> Обратите внимание
> Имя действия и команда, по которой оно вызывается - не одно и то же. Имя действия описано в его конфигурационном файле, в параметре `Name`

Для примера, следующий запрос заставит бота единоразово выполнить действие `RunShell` из реестра действий, результат которого будет отправлен в чат с **числовым** идентификатором `00000000`. При этом, данное действие является скриптом, поэтому ему передаются некоторые аргументы: `-sT -U admin`.

```bash
curl http://127.0.0.1:3200/ --data '{"ActionName": "RunShell","ChatID": "00000000","Args": "-sT -U admin"}'
```

> Обратите внимание!
> Для отправки сообщений в чат используется **только числовой идентификатор** чата пользователя/канала или группы. Если чат не указан, действие **не будет выполнено**

Если действие возможно поставить на выполнение, результатом будет следующий ответ API:

```json
{"Started":"true"}
```

В противном случае API вернет следующий ответ:

```json
{"Started":"false"}
```

> Обратите внимание!
> Наличие ответа от API формата `{"Started":"true"}` - **не показатель** того, что действие будет выполнено без ошибок. Эта строка лишь указывает, что действие будет поставлено в очередь и бот попытается его исполнить, но при наличии ошибок в процессе выполнения **бот не попытается их исправлять или перезапускать действие.** 
